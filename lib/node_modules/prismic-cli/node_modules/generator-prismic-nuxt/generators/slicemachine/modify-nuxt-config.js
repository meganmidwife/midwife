"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const parser = require("@babel/parser");
const traverse_1 = require("@babel/traverse");
const t = require("@babel/types");
const generator_1 = require("@babel/generator");
function getKeys(properties) {
    return properties.reduce((acc, curr) => {
        if (t.isObjectProperty(curr) && t.isIdentifier(curr.key)) {
            return [...acc, curr.key.name];
        }
        return acc;
    }, []);
}
function modifyNuxtConfig(source, domain) {
    const ast = parser.parse(source, { sourceType: 'module' });
    const srcPollyFill = t.objectExpression([t.objectProperty(t.identifier('src'), t.stringLiteral('https://cdn.polyfill.io/v2/polyfill.min.js?features=Element.prototype.classList'))]);
    const srcFocusVisible = t.objectExpression([t.objectProperty(t.identifier('src'), t.stringLiteral('https://cdn.jsdelivr.net/npm/focus-visible@5.0.2/dist/focus-visible.min.js'))]);
    const css = t.stringLiteral('vue-essential-slices/src/styles/styles.scss');
    const modulesToTranspile = t.arrayExpression([
        t.stringLiteral('vue-slicezone'),
        t.stringLiteral('nuxt-sm'),
    ]);
    const transpile = t.objectProperty(t.identifier('transpile'), modulesToTranspile);
    const modules = t.arrayExpression([
        t.stringLiteral('@nuxtjs/prismic'),
        t.objectExpression([
            t.objectProperty(t.identifier('endpoint'), t.stringLiteral(`https://${domain}.cdn.prismic.io/api/v2`)),
            t.objectProperty(t.identifier('apiOptions'), t.objectExpression([
                t.objectProperty(t.identifier('routes'), t.arrayExpression([
                    t.objectExpression([
                        t.objectProperty(t.identifier('type'), t.stringLiteral('page')),
                        t.objectProperty(t.identifier('path'), t.stringLiteral('/:uid')),
                    ]),
                ])),
            ])),
        ]),
    ]);
    traverse_1.default(ast, {
        ObjectExpression(path) {
            path.node.properties.forEach((prop) => {
                if (t.isObjectProperty(prop) && t.isIdentifier(prop.key) && t.isObjectExpression(prop.value) && prop.key.name === 'head') {
                    const keys = getKeys(prop.value.properties);
                    const hasScript = keys.includes('script');
                    if (hasScript === false) {
                        return prop.value.properties.push(t.objectProperty(t.identifier('script'), t.arrayExpression([
                            srcPollyFill,
                            srcFocusVisible,
                        ])));
                    }
                    return prop.value.properties.forEach(headProp => {
                        if (t.isObjectProperty(headProp) && t.isIdentifier(headProp.key) && t.isArrayExpression(headProp.value) && headProp.key.name === 'script') {
                            headProp.value.elements.push(srcPollyFill, srcFocusVisible);
                        }
                    });
                }
                if (t.isObjectProperty(prop) && t.isIdentifier(prop.key) && t.isArrayExpression(prop.value) && prop.key.name === 'css') {
                    return prop.value.elements.push(css);
                }
                if (t.isObjectProperty(prop) && t.isIdentifier(prop.key) && t.isArrayExpression(prop.value) && prop.key.name === 'modules') {
                    return prop.value.elements.push(modules);
                }
                if (t.isObjectProperty(prop) && t.isIdentifier(prop.key) && t.isObjectExpression(prop.value) && prop.key.name === 'build') {
                    const keys = getKeys(prop.value.properties);
                    const hasTranspile = keys.includes('transpile');
                    if (hasTranspile === false) {
                        return prop.value.properties.push(transpile);
                    }
                    return prop.value.properties.forEach(buildProp => {
                        if (t.isObjectProperty(buildProp) && t.isIdentifier(buildProp.key) && t.isArrayExpression(buildProp.value) && buildProp.key.name === 'transpile') {
                            buildProp.value.elements.push(modulesToTranspile);
                        }
                    });
                }
            });
        },
    });
    const { code } = generator_1.default(ast, { /* config */}, source);
    return code;
}
exports.default = modifyNuxtConfig;
